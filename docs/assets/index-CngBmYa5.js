import{_ as P,g as R,j as D,m as V,c as w,o as u,a as E,s as $,h as H,f as W,u as j,p as G,t as I,q as C,F as X,w as F,k as Y,e as q}from"./index-D5DTCYcu.js";import{E as B,q as K,a as J,u as Q}from"./index-GdVHNLJM.js";import{E as Z,a as x}from"./empty-DmwoCSLv.js";import"./vnode-CdZXl-7f.js";const ee={__name:"CanvasLottery",props:{participants:{type:Array,default:()=>[]},winnerCount:{type:Number,default:1},themeColor:{type:String,default:"#FF8C00"}},emits:["finished"],setup(N,{expose:h,emit:z}){const l=N,c=z,m=R(null),p=R(null);let _=null,S=null,f=[],k=!1,g=!1;class M{constructor(e,t,o,s){this.updateRect(e,t,o,s),this.currentUser={name:"等待开奖",id:"****"},this.targetUser=null,this.state="idle",this.speed=20,this.lastUpdate=0,this.stopDelay=0,this.stopStartTime=0}updateRect(e,t,o,s){this.x=e,this.y=t,this.w=o,this.h=s}update(e,t){if(this.state==="rolling")e-this.lastUpdate>1e3/this.speed&&(this.currentUser=t[Math.floor(Math.random()*t.length)],this.lastUpdate=e);else if(this.state==="stopping"){if(e<this.stopStartTime+this.stopDelay)return;this.speed*=.95,this.speed<2?(this.currentUser=this.targetUser,this.state="locked"):e-this.lastUpdate>1e3/this.speed&&(this.currentUser=t[Math.floor(Math.random()*t.length)],this.lastUpdate=e)}}draw(e,t){const{x:o,y:s,w:d,h:n}=this,v=8;e.save(),e.shadowBlur=this.state==="locked"?15:0,e.shadowColor=t;const y=e.createLinearGradient(o,s,o,s+n);y.addColorStop(0,"rgba(40, 40, 40, 0.85)"),y.addColorStop(1,"rgba(15, 15, 15, 0.95)"),e.fillStyle=y,e.strokeStyle=this.state==="locked"?t:"rgba(255,255,255,0.15)",e.lineWidth=this.state==="locked"?2:1,this.roundRect(e,o+v,s+v,d-v*2,n-v*2,6),e.fill(),e.stroke(),e.restore(),e.save(),e.textAlign="center",e.textBaseline="middle";const L=Math.floor(n*.15);e.font=`bold ${L}px "Microsoft YaHei", sans-serif`,e.fillStyle=this.state==="locked"?t:"#FFFFFF",e.fillText(this.currentUser.name,o+d/2,s+n*.42);const T=Math.floor(n*.08);e.font=`${T}px "Consolas", "Monaco", monospace`,e.fillStyle=this.state==="locked"?"rgba(255,255,255,0.9)":"rgba(255,255,255,0.45)",e.fillText(`${this.currentUser.ldap||"***"}`,o+d/2,s+n*.62),e.restore()}roundRect(e,t,o,s,d,n){e.beginPath(),e.moveTo(t+n,o),e.arcTo(t+s,o,t+s,o+d,n),e.arcTo(t+s,o+d,t,o+d,n),e.arcTo(t,o+d,t,o,n),e.arcTo(t,o,t+s,o,n),e.closePath()}}const U=()=>{if(!p.value||!m.value)return;const r=m.value.getBoundingClientRect(),e=window.devicePixelRatio||1;p.value.width=r.width*e,p.value.height=r.height*e,_.scale(e,e);const t=l.winnerCount,o=r.width/r.height;let s=Math.ceil(Math.sqrt(t*o)),d=Math.ceil(t/s);const n=r.width/s,v=r.height/d;f=[];for(let y=0;y<t;y++){const L=Math.floor(y/s),T=y%s,O=L===d-1&&t%s||s,A=(r.width-O*n)/2;f.push(new M(T*n+A,L*v,n,v))}},b=r=>{_.clearRect(0,0,p.value.width,p.value.height);let e=!0;if(f.forEach(t=>{t.update(r,l.participants),t.draw(_,l.themeColor),t.state!=="locked"&&(e=!1)}),g&&e){k=!1,g=!1,c("finished",f.map(t=>t.targetUser));return}S=requestAnimationFrame(b)};return h({start:()=>{k||(k=!0,g=!1,f.forEach(r=>{r.state="rolling",r.speed=20+Math.random()*10}))},stop:()=>{if(!k||g)return;g=!0;const r=[...l.participants].sort(()=>Math.random()-.5).slice(0,l.winnerCount),e=performance.now();f.forEach((t,o)=>{t.targetUser=r[o],t.state="stopping",t.stopStartTime=e,t.stopDelay=o*150+Math.random()*200})}}),D(()=>{_=p.value.getContext("2d"),U(),b(0),window.addEventListener("resize",U)}),V(()=>{window.removeEventListener("resize",U),cancelAnimationFrame(S)}),(r,e)=>(u(),w("div",{class:"lottery-stage",ref_key:"container",ref:m},[E("canvas",{ref_key:"canvasRef",ref:p},null,512)],512))}},te=P(ee,[["__scopeId","data-v-1cc055ab"]]),se={class:"big-screen"},re={class:"header"},oe={class:"main-title"},ae={key:0,class:"main-desc"},ne={class:"main-area"},ie={key:0,class:"footer-actions"},le={key:1,class:"footer-actions"},ce={__name:"index",setup(N){const h=W(),z=j(),l=$([]),c=H({title:"",desc:"",isOver:!1,prizeNum:"",prizeUserList:[]});D(()=>{_()});const m=R(null),p=R(!1);R(!1);const _=()=>{const i=h.query.lotteryKey,a=h.query.prizeIndex;if(!i||!a){B.alert("当前链接有误","温馨提示",{confirmButtonText:"确定"});return}K({key:i}).then(r=>{if(r?.success){const{lotteryPrize:e,lotteryUser:t,status:o}=r.data[0],s=e[Number(a)];if(s.isOver){B.alert("当前奖项已抽完","温馨提示",{confirmButtonText:"确定"}).then(()=>{z.replace({path:"/",query:{lotteryKey:h.query.lotteryKey}})});return}if(!o){B.alert("当前抽奖活动未开始","温馨提示",{confirmButtonText:"确定"}).then(()=>{z.replace({path:"/",query:{lotteryKey:h.query.lotteryKey}})});return}c.title=s.title,c.desc=s.desc,c.prizeNum=s.prizeNum,S(r.data[0],s)}})},S=(i,a)=>{if(["是",!0].includes(a.isDeduplication)){l.value=i.lotteryUser;return}const r=[];i.lotteryPrize.forEach(e=>{e.prizeUserList.forEach(t=>{r.push(t.ldap)})}),l.value=f(i.lotteryUser,r)},f=(i,a)=>{const r=new Set(a);return i.filter(e=>!r.has(e.ldap))},k=()=>{p.value=!0,m.value.start()},g=()=>{m.value.stop()},M=()=>{z.push({path:"/",query:{lotteryKey:h.query.lotteryKey}})},U=i=>{c.isOver=!0,b(i)},b=i=>{const a=h.query.lotteryKey,r=h.query.prizeIndex;K({key:a}).then(e=>{if(e?.success){const{lotteryPrize:t}=e.data[0],o=t[Number(r)];o.prizeUserList=i,o.isOver=!0,Q({key:a,lotteryPrize:t}).then(s=>{s?.success&&x.success("保存成功")})}})};return(i,a)=>{const r=Z,e=J;return u(),w("div",se,[E("div",re,[E("h1",oe,I(c.title||"幸运大抽奖"),1),c.desc?(u(),w("div",ae,I(c.desc),1)):G("",!0)]),E("div",ne,[l.value.length>0?(u(),C(te,{key:0,ref_key:"lotteryRef",ref:m,participants:l.value,"winner-count":c.prizeNum,"theme-color":"#FF8C00",onFinished:U},null,8,["participants","winner-count"])):(u(),C(r,{key:1,description:"请先添加员工"}))]),c?.isOver?(u(),w("div",le,[Y(e,{type:"danger",size:"large",onClick:M,class:"action-btn stop"},{default:F(()=>[...a[3]||(a[3]=[q(" 返回 ",-1)])]),_:1})])):(u(),w("div",ie,[l.value.length>0?(u(),w(X,{key:0},[p.value?(u(),C(e,{key:1,type:"danger",size:"large",onClick:g,class:"action-btn stop"},{default:F(()=>[...a[1]||(a[1]=[q(" 停止 ",-1)])]),_:1})):(u(),C(e,{key:0,type:"warning",size:"large",onClick:k,class:"action-btn start"},{default:F(()=>[...a[0]||(a[0]=[q(" 开始抽奖 ",-1)])]),_:1}))],64)):(u(),C(e,{key:1,type:"danger",size:"large",onClick:M,class:"action-btn stop"},{default:F(()=>[...a[2]||(a[2]=[q(" 返回 ",-1)])]),_:1}))]))])}}},fe=P(ce,[["__scopeId","data-v-4ee7d7d2"]]);export{fe as default};
